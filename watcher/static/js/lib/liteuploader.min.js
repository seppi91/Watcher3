!function(t){var e={fn:{}};"object"==typeof module&&"object"==typeof module.exports?module.exports=t($||e):t($||e)}(function(t){function e(t,e,i){this.options=this._applyDefaults(t),this._getFiles=e,this._triggerEvent=i,this.xhrs=[]}return t.fn.liteUploader=function(i){return this.each(function(){i.ref=i.ref||t(this).attr("name");var n=function(){return t(this).get(0).files}.bind(this),r=function(e,i){t(this).trigger.bind(t(this))(e,[i])}.bind(this);t.data(this,"liteUploader",new e(i,n,r))})},e.prototype={_applyDefaults:function(t){return Object.assign({script:null,ref:null,rules:{},params:{},headers:{},validators:[],singleFileUploads:!1,beforeRequest:function(t,e){return Promise.resolve(e)}},t)},_init:function(t){if(!(t=t||this._getFiles())||!t.length)throw new Error("No files");return Promise.all([this._validateOptions(),this._validateFiles(t)]).then(function(e){var i=e[0];i||(i=e[1]),i?this._triggerEvent("lu:errors",i):(this._triggerEvent("lu:start",t),this.xhrs=[],this._startUpload(t))}.bind(this))},_startUpload:function(t){return this._splitFiles(t).map(function(t){var e=this._buildXhrObject(t);return this._beforeRequest(t).then(function(t){return e.send(t)})}.bind(this))},_splitFiles:function(t){return this.options.singleFileUploads?Array.prototype.map.call(t,function(t){return[t]}):[t]},_beforeRequest:function(t){this._triggerEvent("lu:before",t);var e=this._collateFormData(t);return this.options.beforeRequest(t,e)},_validateOptions:function(){var t=["script","ref"].reduce(function(t,e){return this.options[e]||t.push({type:e+"Required"}),t}.bind(this),[]);return t.length?[{name:"_options",errors:t}]:null},_allowedFileTypeValidator:function(t,e){var i=t.split(","),n=/([a-z]+)\/\*$/;if(-1===i.indexOf(e.type))return i.reduce(function(t,i){return t||(i.match(n)||[])[1]===e.type.split("/")[0]},!1)?void 0:{type:"type",rule:t,given:e.type}},_maxSizeValidator:function(t,e){if(e.size>t)return{type:"size",rule:t,given:e.size}},_validateFiles:function(t){var e=Array.prototype.map.call(t,function(t){return this._validateFile(t)}.bind(this));return Promise.all(e).then(function(t){var e=t.filter(function(t){return t.errors.length});return e.length?e:null})},_validateFile:function(t){var e={allowedFileTypes:this._allowedFileTypeValidator,maxSize:this._maxSizeValidator},i=Object.keys(this.options.rules).reduce(function(i,n){var r=this.options.rules[n];return r&&e[n]&&i.push(e[n](r,t)),i}.bind(this),[]),n=this.options.validators.map(function(e){return e(t)});return Promise.all(i.concat(n)).then(function(e){return{name:t.name,errors:e.filter(function(t){return!!t})}})},_collateFormData:function(t){var e=new FormData;for(var i in this.options.params)e.append(i,this.options.params[i]);return Array.prototype.forEach.call(t,function(t){e.append(this.options.ref,t)}.bind(this)),e},_getXmlHttpRequestObject:function(){return new XMLHttpRequest},_buildXhrObject:function(t){var e=this._getXmlHttpRequestObject();e.open("POST",this.options.script);for(var i in this.options.headers)e.setRequestHeader(i,this.options.headers[i]);return e.upload.addEventListener("progress",this._onXHRProgress.bind(this,t),!1),e.onreadystatechange=function(){this._onXHRResponse(e)}.bind(this),this.xhrs.push(e),e},_onXHRProgress:function(t,e){e.lengthComputable&&this._triggerEvent("lu:progress",{percentage:Math.floor(e.loaded/e.total*100),files:t})},_onXHRResponse:function(t){4===t.readyState&&(200===t.status?this._triggerEvent("lu:success",t.responseText):this._triggerEvent("lu:fail",t))},startUpload:function(t){this._init(t)},addParam:function(t,e){this.options.params[t]=e},cancelUpload:function(){this._triggerEvent("lu:cancelled"),this.xhrs.forEach(function(t){t.abort()})}},e});